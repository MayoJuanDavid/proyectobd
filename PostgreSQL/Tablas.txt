-- CREACION DE LAS TABLAS CON SU SECUENCIA CORRESPONDIENTE -------------------------------------------------------------------------

-- PAIS
CREATE SEQUENCE id_pais_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE paises(
    id_pais INTEGER DEFAULT nextval('id_pais_secuencia') PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL UNIQUE
);

-- FLOR CORTE
CREATE SEQUENCE id_flor_corte_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE flores_cortes(
    id_flor_corte INTEGER DEFAULT nextval('id_flor_corte_secuencia') PRIMARY KEY,
    nombre_comun VARCHAR(50) NOT NULL UNIQUE,
    etimologia VARCHAR(300) NOT NULL,
    genero_especie VARCHAR(100) NOT NULL,
    colores VARCHAR(100) NOT NULL,
    temperatura NUMERIC(3,2) NOT NULL
);

-- COLOR FLOR
CREATE TABLE colores_flores(
    cod_hex VARCHAR(15) PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL,
    descripcion VARCHAR(300) NOT NULL
);

-- SIGNIFICADO
CREATE SEQUENCE id_significado_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE significados(
    id_significado INTEGER DEFAULT nextval('id_significado_secuencia') PRIMARY KEY,
    descripcion VARCHAR(300),
    tipo VARCHAR(20) NOT NULL,
	
	CONSTRAINT CHK_tipo CHECK (tipo IN ('Ocasion', 'Sentimiento'))
);

-- CLIENTE FLORISTERIA
CREATE SEQUENCE id_cliente_floristeria_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE clientes_floristerias(
    id_cliente_floristeria INTEGER DEFAULT nextval('id_cliente_floristeria_secuencia') PRIMARY KEY,
    primer_nombre VARCHAR(50) NOT NULL,
    primer_apelliddo VARCHAR(50) NOT NULL,
    documento_identidad VARCHAR(50) NOT NULL,
    fecha_nacimiento DATE NOT NULL,
	segundo_nombre VARCHAR(50)
);

-- PRODUCTOR
CREATE SEQUENCE id_productor_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE productores(
    id_productor INTEGER DEFAULT nextval('id_productor_secuencia') PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL UNIQUE,
    sitio_web VARCHAR(100) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    id_pais INTEGER NOT NULL,
	
    CONSTRAINT FK_pais FOREIGN KEY(id_pais) REFERENCES paises(id_pais)
);

-- SUBASTADORA
CREATE SEQUENCE id_subastadora_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE subastadoras(
    id_subastadora INTEGER DEFAULT nextval('id_subastadora_secuencia') PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL UNIQUE,
    id_pais INTEGER NOT NULL,
	
    CONSTRAINT FK_pais FOREIGN KEY(id_pais) REFERENCES paises(id_pais)
);

-- CONTRATO
CREATE SEQUENCE id_contrato_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE contratos(
    id_contrato INTEGER DEFAULT nextval('id_contrato_secuencia') NOT NULL UNIQUE,
	id_productor INTEGER NOT NULL,
    id_subastadora INTEGER NOT NULL,
    porcentaje_produccion_total NUMERIC(5,2) NOT NULL,
    fecha_firma DATE NOT NULL,
    clasificacion VARCHAR(5) NOT NULL,
	fecha_cierre_cancelacion DATE,
    id_contrato_renovado INTEGER, -- Referencia al contrato renovado (opcional)
	id_productor_renovado INTEGER, -- Referencia al contrato renovado (opcional)
	id_subastadora_renovado INTEGER, -- Referencia al contrato renovado (opcional)
	
    CONSTRAINT PK_contrato PRIMARY KEY (id_contrato, id_productor, id_subastadora),
    CONSTRAINT FK1_productor FOREIGN KEY (id_productor) REFERENCES productores (id_productor),
    CONSTRAINT FK2_subastadora FOREIGN KEY (id_subastadora) REFERENCES subastadoras (id_subastadora),
    CONSTRAINT FK3_contrato_renovado FOREIGN KEY (id_contrato_renovado,id_productor_renovado,id_subastadora_renovado) REFERENCES contratos(id_contrato, id_productor, id_subastadora),
	CONSTRAINT U_contrato_renovado UNIQUE (id_contrato_renovado,id_productor_renovado,id_subastadora_renovado),
	CONSTRAINT CHK_clasificacion CHECK (clasificacion IN ('CA', 'CB', 'CC', 'CG', 'KA'))
);

-- CATALOGO PRODUCTOR
CREATE TABLE catalogos_productores(
    cod_vbn VARCHAR(10) NOT NULL,
	id_productor INTEGER NOT NULL,
    nombre VARCHAR(50) NOT NULL UNIQUE,
	id_flor_corte INTEGER NOT NULL,
    descripcion VARCHAR(300),
	
    CONSTRAINT PK_catalogo_productor PRIMARY KEY(cod_vbn, id_productor),
    CONSTRAINT FK1_productor FOREIGN KEY(id_productor) REFERENCES productores(id_productor),
    CONSTRAINT FK2_flor_corte FOREIGN KEY(id_flor_corte) REFERENCES flores_cortes(id_flor_corte)
);

-- PAGO
CREATE SEQUENCE id_pago_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE pagos(
    id_pago INTEGER DEFAULT nextval('id_pago_secuencia'),
	id_contrato INTEGER NOT NULL,
    id_productor INTEGER NOT NULL,
    id_subastadora INTEGER NOT NULL,
    monto NUMERIC(9,2) NOT NULL,
    tipo VARCHAR(10) NOT NULL,
    fecha_pago DATE NOT NULL,
	
    CONSTRAINT PK_pago PRIMARY KEY(id_pago, id_contrato, id_productor, id_subastadora),
    CONSTRAINT FK_contrato FOREIGN KEY(id_contrato, id_productor, id_subastadora) REFERENCES contratos(id_contrato, id_productor, id_subastadora),
	CONSTRAINT CHK_tipo_pago CHECK (tipo IN ('Membresia', 'Multa', 'Comision'))
);

-- FLORISTERIA
CREATE SEQUENCE id_floristeria_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE floristerias(
    id_floristeria INTEGER DEFAULT nextval('id_floristeria_secuencia') PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    id_pais INTEGER NOT NULL,
	
    CONSTRAINT FK_pais FOREIGN KEY(id_pais) REFERENCES paises(id_pais)
);

-- PERSONAL
CREATE SEQUENCE id_personal_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE personales(
    id_personal INTEGER DEFAULT nextval('id_personal_secuencia'),
	id_floristeria INTEGER NOT NULL,
    primer_nombre VARCHAR(50) NOT NULL,
    primer_apelliddo VARCHAR(50) NOT NULL,
    documento_identidad VARCHAR(50) NOT NULL,
    fecha_nacimiento DATE NOT NULL,
	segundo_nombre VARCHAR(50),
    
    CONSTRAINT PK_personal PRIMARY KEY(id_personal, id_floristeria),
    CONSTRAINT FK_floristeria FOREIGN KEY(id_floristeria) REFERENCES floristerias(id_floristeria)
);

-- DETALLE CONTRATO

CREATE TABLE detalles_contratos(
	cod_vbn VARCHAR(10) NOT NULL,
	id_productor INTEGER NOT NULL,
    id_contrato INTEGER NOT NULL,
    id_subastadora INTEGER NOT NULL,
    cantidad INTEGER NOT NULL,
    
    CONSTRAINT PK_detalle_contrato PRIMARY KEY(cod_vbn, id_productor, id_contrato, id_subastadora),
    CONSTRAINT FK1_catalogo FOREIGN KEY(cod_vbn, id_productor) REFERENCES catalogos_productores(cod_vbn, id_productor),
    CONSTRAINT FK2_contrato FOREIGN KEY(id_contrato, id_productor, id_subastadora) REFERENCES contratos(id_contrato, id_productor, id_subastadora)
);

-- AFILIACION

CREATE TABLE afiliaciones(
    id_subastadora INTEGER NOT NULL,
    id_floristeria INTEGER NOT NULL,
	
    CONSTRAINT PK_afiliacion PRIMARY KEY(id_subastadora, id_floristeria),
    CONSTRAINT FK1_subastadora FOREIGN KEY(id_subastadora) REFERENCES subastadoras(id_subastadora),
    CONSTRAINT FK2_floristeria FOREIGN KEY(id_floristeria) REFERENCES floristerias(id_floristeria)
);

-- FACTURA COMPRA
CREATE SEQUENCE id_factura_compra_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE facturas_compras(
    id_factura INTEGER DEFAULT nextval('id_factura_compra_secuencia') PRIMARY KEY,
    fecha_emision DATE NOT NULL,
    monto_total NUMERIC(9,2) NOT NULL,
	id_subastadora INTEGER NOT NULL,
    id_floristeria INTEGER NOT NULL,
    envio NUMERIC(9,2),
    
    CONSTRAINT FK_afiliacion FOREIGN KEY(id_subastadora, id_floristeria) REFERENCES afiliaciones(id_subastadora, id_floristeria)
);

-- LOTE
CREATE SEQUENCE id_lote_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE lotes(
    id_lote INTEGER DEFAULT nextval('id_lote_secuencia'),
	-- Factura
	id_factura_compra INTEGER NOT NULL,
	-- Detalle contrato
	-- /Catalogo
	cod_vbn VARCHAR(10) NOT NULL,
	id_productor INTEGER NOT NULL,
	-- /Contrato
    id_contrato INTEGER NOT NULL,
    id_subastadora INTEGER NOT NULL,
    cantidad INTEGER NOT NULL,
    precio_inicial NUMERIC(9,2) NOT NULL,
    indice_calidad NUMERIC(2,1) NOT NULL,
    precio_final NUMERIC(9,2) NOT NULL,
	
    CONSTRAINT PK_lote PRIMARY KEY(id_lote, id_factura_compra, cod_vbn, id_productor,id_contrato, id_subastadora),
    CONSTRAINT FK1_factura_compra FOREIGN KEY(id_factura_compra) REFERENCES facturas_compras(id_factura),
    CONSTRAINT FK2_detalle_contrato FOREIGN KEY(cod_vbn, id_productor, id_contrato, id_subastadora) REFERENCES detalles_contratos(cod_vbn, id_productor, id_contrato, id_subastadora)
);

-- ENLACE
CREATE SEQUENCE id_enlace_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE enlaces(
    id_enlace INTEGER DEFAULT nextval('id_enlace_secuencia'),
	id_significado INTEGER NOT NULL,
    descripcion VARCHAR(300),
    cod_hex VARCHAR(15),
	id_flor_corte INTEGER,
    
    CONSTRAINT PK_enlace PRIMARY KEY(id_enlace, id_significado),
    CONSTRAINT FK1_color_flor FOREIGN KEY(cod_hex) REFERENCES colores_flores(cod_hex),
    CONSTRAINT FK2_significado FOREIGN KEY(id_significado) REFERENCES significados(id_significado),
	CONSTRAINT FK3_flor_corte FOREIGN KEY(id_flor_corte) REFERENCES flores_cortes(id_flor_corte)
);

-- FACTURA VENTA
CREATE SEQUENCE id_factura_venta_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE facturas_ventas(
    id_factura_venta INTEGER DEFAULT nextval('id_factura_venta_secuencia'),
	id_floristeria INTEGER NOT NULL,
    id_cliente_floristeria INTEGER NOT NULL,
    fecha DATE NOT NULL,
    total NUMERIC(9,2) NOT NULL,
    
    CONSTRAINT PK_factura_venta PRIMARY KEY(id_factura_venta, id_floristeria),
    CONSTRAINT FK1_floristeria FOREIGN KEY(id_floristeria) REFERENCES floristerias(id_floristeria),
    CONSTRAINT FK2_cliente_floristeria FOREIGN KEY(id_floristeria) REFERENCES clientes_floristerias(id_cliente_floristeria)
);

-- CATALOGO FLORISTERIA
CREATE TABLE catalogos_floristerias(
    cod_vbn VARCHAR(10) NOT NULL,
    id_floristeria INTEGER NOT NULL,
    nombre VARCHAR(50) NOT NULL UNIQUE,
    cod_hex VARCHAR(15) NOT NULL,
    id_flor_corte INTEGER NOT NULL,
	descripcion VARCHAR(300),
	
    CONSTRAINT PK_catalogo_floristeria PRIMARY KEY(cod_vbn, id_floristeria),
    CONSTRAINT FK1_floristeria FOREIGN KEY(id_floristeria) REFERENCES floristerias(id_floristeria),
    CONSTRAINT FK2_color_flor FOREIGN KEY(cod_hex) REFERENCES colores_flores(cod_hex),
    CONSTRAINT FK3_flor_corte FOREIGN KEY(id_flor_corte) REFERENCES flores_cortes(id_flor_corte)
);

-- HISTORICO PRECIO UNITARIO
CREATE TABLE hist_precios_unitarios(
    fecha_inicio DATE NOT NULL,
	cod_vbn VARCHAR(15) NOT NULL,
    id_floristeria INTEGER NOT NULL,
    precio_unitario NUMERIC(9,2) NOT NULL,
    fecha_fin DATE,
    tamano_tallo NUMERIC(5,2),
    
    CONSTRAINT PK_hist_precio_unitario PRIMARY KEY(fecha_inicio, cod_vbn, id_floristeria),
    CONSTRAINT FK_catalogo_floristeria FOREIGN KEY(cod_vbn, id_floristeria) REFERENCES catalogos_floristerias(cod_vbn, id_floristeria)
);

-- DETALLE BOUQUET
CREATE SEQUENCE id_detalle_bouquet_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE detalles_bouquets(
    id_detalle_bouquet INTEGER DEFAULT nextval('id_detalle_bouquet_secuencia'),
    cantidad INTEGER NOT NULL,
    cod_vbn VARCHAR(15) NOT NULL,
    id_floristeria INTEGER NOT NULL,
    descripcion VARCHAR(300),
    tamano_tallo NUMERIC(5,2),
	
    CONSTRAINT PK_detalle_bouquet PRIMARY KEY(id_detalle_bouquet, cod_vbn, id_floristeria),
    CONSTRAINT FK_catalogo_floristeria FOREIGN KEY(cod_vbn, id_floristeria) REFERENCES catalogos_floristerias(cod_vbn, id_floristeria)
);

-- DETALLE FACTURA VENTA
CREATE SEQUENCE detalle_factura_venta_secuencia
	START WITH 1
	INCREMENT BY 1;
	
CREATE TABLE detalles_facturas_ventas(
    id_detalle_factura_venta INTEGER DEFAULT nextval('detalle_factura_venta_secuencia'),
    cantidad INTEGER NOT NULL,
	--Factura
    id_factura_venta INTEGER NOT NULL,
    id_floristeria INTEGER NOT NULL,
	-- Det Bouquet y Catalogo Floristeria
    id_detalle_bouquet INTEGER NOT NULL,
    cod_vbn VARCHAR(15) NOT NULL,
    valor_cantidad NUMERIC(9,2),
    valor_precio NUMERIC(9,2),
    promedio NUMERIC(9,2),
	
    CONSTRAINT PK_detalle_factura_venta PRIMARY KEY(id_detalle_factura_venta, id_factura_venta, id_floristeria),
    CONSTRAINT FK1_factura_venta FOREIGN KEY(id_factura_venta, id_floristeria) REFERENCES facturas_ventas(id_factura_venta, id_floristeria),
    CONSTRAINT FK2_detalle_bouquet FOREIGN KEY(id_detalle_bouquet, cod_vbn, id_floristeria) REFERENCES detalles_bouquets(id_detalle_bouquet, cod_vbn, id_floristeria),
    CONSTRAINT FK3_catalogo_floristeria FOREIGN KEY(cod_vbn, id_floristeria) REFERENCES catalogos_floristerias(cod_vbn, id_floristeria)
);

-- TELEFONO
CREATE TABLE telefonos(
    prefijo INTEGER NOT NULL,
    cod_area INTEGER NOT NULL,
    numero INTEGER NOT NULL,
    tipo VARCHAR(10) NOT NULL,
	-- Floristeria
    id_floristeria INTEGER NOT NULL,
	-- Productor
    id_productor INTEGER NOT NULL,
	-- Personal
    id_personal INTEGER NOT NULL,
	id_floristeria_personal INTEGER NOT NULL,
	-- Subastadora
    id_subastadora INTEGER NOT NULL,
    CONSTRAINT PK_telefono PRIMARY KEY(prefijo, cod_area, numero),
    CONSTRAINT FK1_floristeria FOREIGN KEY(id_floristeria) REFERENCES floristerias(id_floristeria),
    CONSTRAINT FK2_productor FOREIGN KEY(id_productor) REFERENCES productores(id_productor),
    CONSTRAINT FK3_personal FOREIGN KEY(id_personal, id_floristeria_personal) REFERENCES personales(id_personal, id_floristeria),
    CONSTRAINT FK4_subastador FOREIGN KEY(id_subastadora) REFERENCES subastadoras(id_subastadora),
	CONSTRAINT CHK_tipo_telefono CHECK (tipo IN('Fijo, Movil'))
);

